<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1, interactive-widget=resizes-content">
  <title>メニュー</title>

</head>

<body>
  <div class="page active" id="menuPage">
    <div class="settings-panel">
      <div id="tableContainer">
        <div id="guestNumber"></div>
      </div>
      <div class="checkbox-group">
        <strong>食べ物</strong>
        <div class="radio-group">
          <label>
            <input type="radio" id="lunchWeekdaysPASTA" name="food" value="lunchWeekdaysPASTA"
              style="margin-right: 8px;"
              onchange="document.getElementById('pasta').disabled = true; document.getElementById('pasta').checked = false;">
            ランチ（平）パスタのみ
          </label>
          <label>
            <input type="radio" id="lunchWeekdays" name="food" value="lunchWeekdays" style="margin-right: 8px;"
              onchange="document.getElementById('pasta').disabled = true; document.getElementById('pasta').checked = false;">
            ランチ（平）
          </label>
          <label>
            <input type="radio" id="lunchWeekend" name="food" value="lunchWeekend" style="margin-right: 8px;"
              onchange="document.getElementById('pasta').disabled = false;">
            ランチ（祝、末）
          </label>
          <label>
            <input type="radio" id="dinner" name="food" value="dinner" style="margin-right: 8px;"
              onchange="document.getElementById('pasta').disabled = false;">
            ディナー
          </label>
        </div>
        <label>
          <input type="checkbox" id="pasta" style="margin-right: 8px;">
          パスタ
        </label>
      </div>
      <div class="checkbox-group">
        <strong>飲み物</strong>
        <label><input type="checkbox" id="lunchDrinkWeekdays"> ランチドリンク（平）</label>
        <label><input type="checkbox" id="wineWhite"> ワイン白</label>
        <label><input type="checkbox" id="wineRed"> ワイン赤</label>
        <label><input type="checkbox" id="drinks"> ドリンク</label>
      </div>
      <div class="controls">
        <div class="bordercontainer">
          <button class="buttonfullspace" onclick="generateImages()">スタート</button>
          <button class="buttonfullspace" id="showInfoButton" onclick="showInfo()">表示</button>
        </div>
        <div class="bordercontainer no-background">
          <button class="buttonfullspace" onclick="navigateToPriceDatabase()">値段</button>
          <button class="buttonfullspace" onclick="navigateToRecipeDatabase()">レシピ</button>
        </div>
        <div>
          <label for="imageLimit">限定: </label>
          <select id="imageLimit">
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="20" selected>20</option>
          </select>
        </div>
      </div>
    </div>
    <div class="image-panel">
      <div id="imageContainer">
        <div id="flagEmoji"></div>
      </div>
    </div>
  </div>

  <div class="page" id="priceDatabasePage">
    <div id="priceDatabase">
      <div class="price-header">
        <h3>値段</h3>
        <button class="close-price" onclick="navigateToMenu()">閉じる</button>
      </div>
      <div class="searchba">
        <input type="text" id="searchBar" placeholder="メニューを検索..." oninput="filterItems()" autocorrect="off"
          autocomplete="off" spellcheck="false">
      </div>
      <div id="filters">
        <button class="category-filter" data-category="" onclick="zenbu()">リセット</button>
        <button class="category-filter" data-category="前菜" onclick="qfocus()">前菜</button>
        <button class="category-filter" data-category="パスタ" onclick="qfocus()">パスタ</button>
        <button class="category-filter" data-category="ドリンク" onclick="qfocus()">ドリンク</button>
        <button class="category-filter" data-category="ワイン" onclick="qfocus()">ワイン</button>
        <label>
          <input type="checkbox" id="showLunchOnly" onchange="filterItems()"> ランチのみ
        </label>
      </div>
      <div id="itemList"></div>
    </div>
  </div>

  <div class="page" id="recipeDatabasePage">
    <div id="recipeDatabase">
      <div id="recipeDatabaseHeader">
        <h2>レシピ</h2>
        <input type="text" id="recipeSearchBar" placeholder="レシピを検索..." oninput="filterRecipes()" autocorrect="off"
          autocomplete="off" spellcheck="false">
        <button id="recipeBackButton" onclick="navigateToMenu()">メニューに戻る</button>
        <!-- Added Filter Buttons -->
        <div id="recipeFilters">
          <button class="recipe-category-filter" data-category="" onclick="resetRecipeFilter()">リセット</button>
          <button class="recipe-category-filter" data-category="ソース" onclick="focusRecipeSearch()">ソース</button>
          <button class="recipe-category-filter" data-category="前菜" onclick="focusRecipeSearch()">前菜</button>
          <button class="recipe-category-filter" data-category="パスタ" onclick="focusRecipeSearch()">パスタ</button>
        </div>
      </div>
      <div id="recipeContainer">
        <div id="recipeList" role="list"></div>
        <div id="recipeDetails" role="region" aria-label="レシピ詳細"></div>
      </div>
    </div>
  </div>

  <div id="recipeDetailsModal">
    <div id="recipeDetailsModalContent">
      <button id="closeDetails" onclick="closeRecipeDetails()">閉じる</button>
      <div id="recipeModalContent"></div>
    </div>
  </div>

  <div id="infoOverlay">
    <div id="infoContent">
      <button id="closeOverlay" onclick="hideInfo()">閉じる</button>
      <h2 id="menuItemName"></h2>
      <div id="ingredientTableContainer"></div>
      <div class="step-by-step" id="stepSection">
        <!-- <h3>作り方</h3> -->
        <div class="step-image-container" id="stepImageContainer">
          <img id="stepImage" class="step-image" src="" alt="Step Image">
          <button class="step-nav step-prev" onclick="prevStep()" aria-label="前のステップ">◄</button>
          <button class="step-nav step-next" onclick="nextStep()" aria-label="次のステップ">►</button>
        </div>
        <div class="stepper" id="stepper"></div>
        <div class="step-counter" id="stepCounter"></div>
        <div class="step-text" id="stepText"></div>
      </div>
      <div class="video-section" id="videoSection">
      </div>
      <div class="additional-info" id="additionalInfo"></div>
    </div>
  </div>

  <script>
    const imageFolder = 'menu/';

    const excludedItems = ['rh1.avif', 'rh2.avif', 'rh3.avif', 'rh4.avif', 'rh5.avif', 'rh6.avif', 'rh7.avif', 'rh8.avif',]; // Add items to exclude from pricelist here 

    const menuItems = {
      'm1.avif': {
        name: '鶏もも肉のグリル',
        shorthand: 'チキン', // Added shorthand property
        nicknames: ['鶏', 'にわとり', 'ニワトリ', 'チキン', 'chicken', 'ちきん', 'momo', 'chikin', 'chikkin', 'ポルチーニクリームソース'],
        category: 'メイン',
        price: 2380,
        // lunchPrice: 1,
        quantity: 1,
        steps: ['step1-duck.jpg', 'step2-duck.jpg', 'step3-duck.jpg'],
        videoLink: 'https://www.youtube.com/watch?v=example1',
        additionalInfo: [
          { title: '食材', content: '鴨肉、赤ワイン、にんにく、ローズマリー、塩、胡椒' },
          { title: '調理のコツ', content: '低温で長時間調理することで、鴨肉が柔らかくジューシーに仕上がります。' },
          { title: '栄養情報', content: 'カロリー: 450kcal、たんぱく質: 30g、脂質: 20g' }
          ,
          { title: '仕上げ', content: 'パセリ' }
        ],
        ingredients: {
          '鴨肉': '300g',
          '赤ワイン': '200ml',
          'にんにく': '3片',
          'ローズマリー': '2茎',
          '塩': '5g',
          '胡椒': '2g'
        },
        stepText: `"""
        1. 
        2. 
        3. 
        """`
      }
    };



    const multipleItems = {

      'd1.avif': {
        priceMultiple: 770,
        lunchPriceMultiple: 770
      },
      'd5.avif': {
        priceMultiple: 850,
        lunchPriceMultiple: 850
      },
      'd6.avif': {
        priceMultiple: 850,
        lunchPriceMultiple: 850
      },
      'd11.avif': {
        priceMultiple: 770,
      },
      'd20.avif': {
        priceMultiple: 990,
        lunchPriceMultiple: 990
      },
      'd25.avif': {
        priceMultiple: 550,
        lunchPriceMultiple: 300
      },
      'd27.avif': {
        priceMultiple: 700,
        lunchPriceMultiple: 400
      },
      'tan1.avif': {
        priceMultiple: 150,
        lunchPriceMultiple: 150
      },
      'set1.avif': {
        lunchPriceMultiple: 250
      },
      'set2.avif': {
        lunchPriceMultiple: 350
      },
      'set3.avif': {
        lunchPriceMultiple: 700
      },
      'h2.avif': {
        priceMultiple: 150,
      },
      'h10.avif': {
        priceMultiple: 400,
      },
      'h11.avif': {
        priceMultiple: 300,
      },
      'g1.avif': {
        priceMultiple: 550,
        lunchPriceMultiple: 550
      },
      'g2.avif': {
        priceMultiple: 550,
      },
      'g3.avif': {
        priceMultiple: 550,
        lunchPriceMultiple: 550
      },
      'w0.avif': {
        priceMultiple: 990,
        lunchPriceMultiple: 990
      },

    };


    const recipeItems = {
      '1.avif': {
        name: '砂肝のコンフィ',
        nicknames: ['konfi', 'コンフィ', 'こんふぃ', '砂肝', 'sunagimo', 'すなぎも', 'スナギモ', 'horumon', 'hormon', 'ホルモン', 'ワイン', 'wine'],
        category: 'ホルモン',
        tags: ['？mins', 'ホルモン'],
        ingredients: {
          '🅰 砂肝': '2kg',
          '🅰 塩': '50g',
          '🅰 タイム': '２本',
          '🅰 ローリエ': '２枚',
          '🅰 ローズマリー': '２本',
          '白ワイン': '400cc',
          'オイル': '400cc'
        },
        // steps: ['0.avif', '0.avif', '0.avif'],
        // videoLink: 'https://www.youtube.com/watch?v=curryvideo',
        stepText: `"""
        1. 石砂肝をしっかり掃除する
        2. Aの材料で砂肝をもみこみ、1晩マリネする
        3. ワインとオイルの中で100℃ 5~6時間煮る。
        """`
      },


    };

    // const flagList = ['p1.avif', 'p2.avif', 'p3.avif', 'p4.avif', 'p5.avif', 'p6.avif', 'p7.avif', 'p8.avif', 'p9.avif', 'p10.avif', 'p11.avif', 'p12.avif', 'p13.avif', 'p14.avif', 'p15.avif', 'p16.avif', 'p17.avif'];
    const flagList = [''];
    const tableList = ['ta1.avif', 'ta2.avif', 'ta3.avif', 'ta4.avif', 'ta5.avif', 'ta6.avif', 'ta10.avif', 'ta12.avif', 'ta20.avif', 'ta21.avif', 'ta22.avif', 'ta23.avif', 'ta24.avif', 'ta25.avif', 'ta26.avif', 'ta27.avif', 'ta28.avif', 'ta29.avif', 'ta30.avif', 'ta31.avif', 'ta32.avif', 'ta33.avif', 'ta34.avif', 'ta35.avif', 'ta36.avif', 'ta37.avif', 'ta38.avif', 'ta39.avif', 'ta40.avif', 'ta41.avif', 'ta42.avif', 'ta43.avif', 'ta44.avif', 'ta45.avif', 'ta46.avif', 'ta47.avif', 'ta48.avif', 'ta49.avif', 'ta50.avif', 'ta51.avif', 'ta52.avif'];
    const table0 = ['ttt1.avif', 'ttt2.avif', 'ttt3.avif', 'ttt4.avif'];
    const guestNumbersStandard = [1, 2];
    const guestNumbersLarge = [3, 4];
    const guestNumbersEnter = [1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 4, 4];

    const imageListWinesWhite = ['w1.avif', 'w2.avif', 'w3.avif', 'w4.avif', 'w5.avif', 'w6.avif', 'w7.avif', 'w8.avif', 'w9.avif', 'ww1.avif', 'ww2.avif', 'ww3.avif', 'ww4.avif', 'ww5.avif', 'ww6.avif', 'ww7.avif', 'ww8.avif', 'ww9.avif'];
    const imageListWinesRed = ['w10.avif', 'w11.avif', 'w12.avif', 'w13.avif', 'w14.avif', 'w15.avif', 'w16.avif', 'w17.avif', 'w18.avif', 'ww10.avif', 'ww11.avif', 'ww12.avif', 'ww13.avif', 'ww14.avif', 'ww15.avif', 'ww16.avif', 'ww17.avif', 'ww18.avif'];
    const imageListDrinks = ['d1.avif', 'd2.avif', 'd3.avif', 'd4.avif', 'd5.avif', 'd6.avif', 'd7.avif', 'd8.avif', 'd9.avif', 'd10.avif', 'd11.avif', 'd12.avif', 'd13.avif', 'd14.avif', 'd15.avif', 'd16.avif', 'd17.avif', 'd18.avif', 'd19.avif', 'd20.avif', 'd21.avif', 'd22.avif', 'd23.avif', 'd24.avif', 'd25.avif', 'd26.avif', 'd27.avif', 'd28.avif', 'd29.avif'];
    const imageListNoDrink = ['w0.avif', 'd0.avif'];
    const imageListLunchDrinkWeekdays = ['ld1.avif', 'ld2.avif', 'ld3.avif', 'ld4.avif', 'ld5.avif', 'ld6.avif', 'ld7.avif', 'ldwine.avif'];
    const imageListDinnerTodays = ['hon3.avif', 'hon4.avif', 'hon5.avif', 'hon6.avif'];
    const imageListLunchTodaysWeekdays = ['hon1.avif', 'hon2.avif', 'hon2a.avif'];
    const imageListDinnerGyokai = ['g1.avif', 'g2.avif', 'g3.avif', 'g4.avif', 'g5.avif', 'g6.avif'];
    const imageListDinnerCharcuterie = ['c1.avif', 'c2.avif', 'c3.avif'];
    const imageListDinnerHotOven = ['h1.avif', 'h2.avif', 'h3.avif', 'h4.avif', 'h5.avif', 'h6.avif', 'h7.avif', 'h8.avif', 'h9.avif', 'h10.avif', 'h11.avif'];
    const imageListDinnerMainDish = ['m1.avif', 'm2.avif', 'm3.avif', 'm4.avif'];
    const imageListDinnerPasta = ['p1.avif', 'p2.avif', 'p3.avif', 'p4.avif', 'p5.avif', 'p6.avif', 'p7.avif', 'p8.avif', 'p9.avif', 'p10.avif', 'p11.avif', 'p12.avif', 'p13.avif', 'p14.avif', 'p15.avif', 'p16.avif', 'p17.avif'];
    const imageListDinnerSalad = ['s1.avif', 's2.avif', 's3.avif', 's4.avif'];
    const imageListDinnerTapasCold = ['t1.avif', 't2.avif', 't3.avif', 't4.avif', 't5.avif', 't6.avif', 't7.avif'];
    const imageListLunchPastaWeekdays = ['rh1.avif', 'rh2.avif', 'rh3.avif', 'rh4.avif', 'rh5.avif', 'rh6.avif', 'rh7.avif', 'rh8.avif'];
    const imageListLunchPastaWeekdaysNoTodays = ['rh1.avif', 'rh2.avif', 'rh3.avif', 'rh4.avif', 'rh5.avif', 'rh6.avif', 'rh7.avif'];
    const imageListLunchSetWeekdays = ['set1.avif', 'set2.avif', 'set3.avif'];
    const imageListLunchTanpinWeekdays = ['tan1.avif', 'tan2.avif', 'tan3.avif', 'tan4.avif'];
    const imageListLunchTapasWeekdays = ['tapas1.avif', 'tapas2.avif', 'tapas3.avif', 'tapas4.avif'];

    let currentImages = [];
    let currentIndex = 0;
    let isFirstLoad = true;
    let currentStepIndex = 0;
    let currentSteps = [];
    let currentCategoryFilter = '';
    let currentRecipe = null;
    let isMobile = window.innerWidth <= 768;

    function getRandomElement(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function getRandomImagesFromArray(array, maxCount) {
      const count = Math.floor(Math.random() * (maxCount + 1));
      let shuffled = [...array].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    function getRandomImagesFromArrayMin1(array, maxCount) {
      const count = Math.floor(Math.random() * maxCount) + 1; // 1 to maxCount
      let shuffled = [...array].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    function displayImage() {
      const imageContainer = document.getElementById('imageContainer');
      const flagEmoji = document.getElementById('flagEmoji');
      imageContainer.innerHTML = '';

      if (currentImages.length === 0) {
        imageContainer.innerHTML = '<p style="color: #7f8c8d;">画像が選択されていません。</p>';
        return;
      }

      const flagDiv = document.createElement('div');
      flagDiv.id = 'flagEmoji';
      flagDiv.innerHTML = flagList.includes(currentImages[currentIndex]) ? '‼️' : '';
      imageContainer.appendChild(flagDiv);

      const imgElement = document.createElement('img');
      imgElement.src = imageFolder + currentImages[currentIndex];
      imageContainer.appendChild(imgElement);

      const counter = document.createElement('div');
      counter.id = 'imageCounter';
      counter.innerHTML = `${currentIndex + 1}/${currentImages.length}`;
      imageContainer.appendChild(counter);
    }

    function prevImage() {
      currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
      displayImage();
    }

    function nextImage() {
      currentIndex = (currentIndex + 1) % currentImages.length;
      displayImage();
    }

    function generateImages() {
      const guestNumberDiv = document.getElementById('guestNumber');
      const tableContainer = document.getElementById('tableContainer');
      const limit = parseInt(document.getElementById('imageLimit').value);

      let tableIndex, guestNumber, tableImage;
      if (isFirstLoad) {
        tableIndex = table0.indexOf(getRandomElement(table0));
        guestNumber = getRandomElement(guestNumbersEnter);
        tableImage = getRandomElement(table0);
        isFirstLoad = false;
      } else {
        tableIndex = Math.floor(Math.random() * tableList.length);
        tableImage = tableList[tableIndex];
        if (tableImage === 'ta10.avif' || tableImage === 'ta12.avif') {
          guestNumber = getRandomElement(guestNumbersLarge);
        } else {
          guestNumber = getRandomElement(guestNumbersStandard);
        }
      }

      guestNumberDiv.innerHTML = `${guestNumber}名`;
      while (tableContainer.children.length > 1) {
        tableContainer.removeChild(tableContainer.lastChild);
      }
      const tableImg = document.createElement('img');
      tableImg.src = imageFolder + tableImage;
      tableImg.className = 'table-img';
      tableContainer.appendChild(tableImg);

      const allImages = [];

      if (document.getElementById('lunchWeekdays').checked) {
        const lunchSetImages = getRandomImagesFromArray(imageListLunchSetWeekdays, 1);
        allImages.push(...lunchSetImages);
        const lunchTodayImages = getRandomImagesFromArray(imageListLunchTodaysWeekdays, 1);
        allImages.push(...lunchTodayImages);
        allImages.push(...getRandomImagesFromArray(imageListLunchPastaWeekdays, 4));
        allImages.push(...getRandomImagesFromArray(imageListLunchTanpinWeekdays, 1));
        allImages.push(...getRandomImagesFromArray(imageListLunchTapasWeekdays, 1));
      }

      if (document.getElementById('lunchWeekdaysPASTA').checked) {
        allImages.push(...getRandomImagesFromArrayMin1(imageListLunchPastaWeekdaysNoTodays, 4));
      }

      if (document.getElementById('lunchWeekend').checked) {
        const lunchTodayImages = getRandomImagesFromArray(imageListLunchTodaysWeekdays, 2);
        allImages.push(...lunchTodayImages);
        allImages.push(...getRandomImagesFromArray(imageListDinnerGyokai, 2));
        allImages.push(...getRandomImagesFromArray(imageListDinnerCharcuterie, 2));
        allImages.push(...getRandomImagesFromArray(imageListDinnerHotOven, 2));
        allImages.push(...getRandomImagesFromArray(imageListDinnerMainDish, 2));
        allImages.push(...getRandomImagesFromArray(imageListDinnerSalad, 2));
        allImages.push(...getRandomImagesFromArray(imageListDinnerTapasCold, 2));
      }

      if (document.getElementById('dinner').checked) {
        allImages.push(...getRandomImagesFromArray(imageListDinnerGyokai, 1));
        allImages.push(...getRandomImagesFromArray(imageListDinnerCharcuterie, 1));
        allImages.push(...getRandomImagesFromArray(imageListDinnerHotOven, 1));
        allImages.push(...getRandomImagesFromArray(imageListDinnerMainDish, 1));
        allImages.push(...getRandomImagesFromArray(imageListDinnerSalad, 1));
        allImages.push(...getRandomImagesFromArray(imageListDinnerTapasCold, 1));
      }

      if (document.getElementById('pasta').checked) {
        let pastaImages = getRandomImagesFromArray(imageListDinnerPasta, 4);
        if (pastaImages.length === 0) {
          pastaImages = [getRandomElement(imageListDinnerPasta)];
        }
        allImages.push(...pastaImages);
      }

      if (document.getElementById('wineWhite').checked) {
        allImages.push(...getRandomImagesFromArray(imageListWinesWhite, 2));
      }

      if (document.getElementById('wineRed').checked) {
        allImages.push(...getRandomImagesFromArray(imageListWinesRed, 2));
      }

      if (document.getElementById('drinks').checked) {
        if (Math.random() < 0.05) {
          allImages.push(...imageListNoDrink);
        } else {
          allImages.push(...getRandomImagesFromArray(imageListDrinks, 2));
        }
      }

      if (document.getElementById('lunchDrinkWeekdays').checked) {
        if (Math.random() < 0.05) {
          allImages.push(...imageListNoDrink);
        } else {
          allImages.push(...getRandomImagesFromArray(imageListLunchDrinkWeekdays, 2));
        }
      }

      currentImages = allImages.slice(0, limit);
      shuffleArray(currentImages);
      currentIndex = 0;

      console.log('Generated currentImages:', currentImages); // Log to confirm array contents
      preloadImages(currentImages); // Preload all images immediately
      displayImage();
    }

    let touchStartX = 0;
    let touchStartY = 0;
    const swipeThreshold = 50;

    document.addEventListener('touchstart', (event) => {
      touchStartX = event.changedTouches[0].screenX;
      touchStartY = event.changedTouches[0].screenY;
    });

    document.addEventListener('touchend', (event) => {
      const touchEndX = event.changedTouches[0].screenX;
      const touchEndY = event.changedTouches[0].screenY;
      handleGesture(touchEndX, touchEndY);
    });

    function handleGesture(touchEndX, touchEndY) {
      const diffX = touchEndX - touchStartX;
      const diffY = touchEndY - touchStartY;

      if (Math.abs(diffX) > Math.abs(diffY)) {
        if (diffX > swipeThreshold) {
          if (isMobile && currentSteps.length > 0) {
            prevStep();
          } else {
            prevImage();
          }
        } else if (diffX < -swipeThreshold) {
          if (isMobile && currentSteps.length > 0) {
            nextStep();
          } else {
            nextImage();
          }
        }
      }
    }

    document.addEventListener('keydown', (event) => {
      if (currentImages.length <= 1 && !currentRecipe) return;
      if (event.key === 'ArrowLeft') {
        if (currentSteps.length > 0) prevStep();
        else prevImage();
      } else if (event.key === 'ArrowRight') {
        if (currentSteps.length > 0) nextStep();
        else nextImage();
      } else if (event.key === 'ArrowUp') {
        nextImage();
      } else if (event.key === 'ArrowDown') {
        prevImage();
      } else if (event.key === 'Escape') {
        closeRecipeDetails();
        hideInfo();
      }
    });

    function showInfo() {
      if (currentImages.length === 0 || currentIndex >= currentImages.length) {
        console.log('No images or invalid index:', currentImages, currentIndex);
        return;
      }

      const currentImage = currentImages[currentIndex];
      console.log('Current Image:', currentImage);
      console.log('Available menuItems keys:', Object.keys(menuItems));

      const hasMenuItem = Object.keys(menuItems).includes(currentImage);
      const menuItemName = document.getElementById('menuItemName');

      if (!hasMenuItem) {
        console.log(`No menu item found for ${currentImage}. Hiding step-by-step section.`);
        menuItemName.innerHTML = 'メニュー情報なし';
        document.getElementById('ingredientTableContainer').innerHTML = '';
        document.getElementById('stepSection').style.display = 'none';
        document.getElementById('videoSection').style.display = 'none';
        document.getElementById('infoOverlay').style.display = 'flex';
        return;
      }

      const item = menuItems[currentImage];
      console.log('Selected Item:', item);

      // Preload popup step images
      currentSteps = item.steps || [];
      if (currentSteps.length > 0) {
        preloadImages(currentSteps);
      }

      menuItemName.innerHTML = `${item.name}${item.shorthand ? `<br><span class="shorthand-popup">${item.shorthand}</span>` : ''}`;

      const ingredientTableContainer = document.getElementById('ingredientTableContainer');
      ingredientTableContainer.innerHTML = '';
      if (Object.keys(item.ingredients).length > 0) {
        const table = document.createElement('table');
        table.className = 'ingredient-table';
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>材料</th><th>量</th>';
        thead.appendChild(headerRow);
        for (const [ingredient, amount] of Object.entries(item.ingredients)) {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${ingredient}</td><td>${amount}</td>`;
          tbody.appendChild(row);
        }
        table.appendChild(thead);
        table.appendChild(tbody);
        ingredientTableContainer.appendChild(table);
      }

      currentStepIndex = 0;
      console.log('Current Steps:', currentSteps);

      const stepSection = document.getElementById('stepSection');
      const stepContainer = document.getElementById('stepImageContainer');
      const stepImage = document.getElementById('stepImage');
      const stepCounter = document.getElementById('stepCounter');
      const stepper = document.getElementById('stepper');
      const stepText = document.getElementById('stepText');

      if (currentSteps.length > 0) {
        stepSection.style.display = 'block';
        stepContainer.style.display = 'block';
        stepImage.src = imageFolder + currentSteps[currentStepIndex];
        console.log('Step Image Source:', stepImage.src);
        stepCounter.textContent = `${currentStepIndex + 1}/${currentSteps.length}`;

        stepper.innerHTML = '';
        currentSteps.forEach((_, index) => {
          const dot = document.createElement('span');
          dot.className = 'step-dot';
          dot.setAttribute('aria-label', `ステップ ${index + 1}`);
          dot.onclick = () => goToStep(index);
          if (index === currentStepIndex) dot.classList.add('active');
          stepper.appendChild(dot);
        });
      } else {
        stepSection.style.display = 'none';
        stepContainer.style.display = 'none';
        stepCounter.textContent = '';
        stepper.innerHTML = '';
      }
      stepText.innerHTML = parseStepText(item.stepText);

      const videoSection = document.getElementById('videoSection');
      if (item.videoLink) {
        const videoLink = document.createElement('a');
        videoLink.href = item.videoLink;
        videoLink.target = '_blank';
        videoLink.textContent = 'レシピ動画';
        videoSection.appendChild(videoLink);
        videoSection.style.display = 'block';
      } else {
        videoSection.style.display = 'none';
      }

      const additionalInfo = document.getElementById('additionalInfo');
      additionalInfo.innerHTML = '';
      additionalInfo.style.display = 'block';
      if (item.additionalInfo && item.additionalInfo.length > 0) {
        item.additionalInfo.forEach(info => {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = info.title;
          const content = document.createElement('p');
          content.textContent = info.content;
          details.appendChild(summary);
          details.appendChild(content);
          additionalInfo.appendChild(details);
        });
      } else {
        additionalInfo.innerHTML = '';
      }

      document.getElementById('infoOverlay').style.display = 'flex';
    }

    function parseStepText(text) {
      if (!text || typeof text !== 'string')
        // return '<p>ステップ情報がありません</p>';
        return '';
      let content = text.replace(/^"""/, '').replace(/"*"*$/, '').trim();
      const lines = content.split('\n').map(line => line.trim());
      let html = '';
      lines.forEach(line => {
        if (line.match(/^\d+\./)) {
          html += `<p><strong>${line}</strong></p>`;
        } else if (line) {
          let formatted = line.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/\*(.*?)\*/g, '<i>$1</i>');
          html += `<p>${formatted}</p>`;
        }
      });
      return html;
    }

    function hideInfo() {
      document.getElementById('infoOverlay').style.display = 'none';
      currentStepIndex = 0;
      currentSteps = [];
    }

    function prevStep() {
      if (currentSteps.length === 0) return;
      currentStepIndex = (currentStepIndex - 1 + currentSteps.length) % currentSteps.length;
      updateStepDisplay();
    }

    function nextStep() {
      if (currentSteps.length === 0) return;
      currentStepIndex = (currentStepIndex + 1) % currentSteps.length;
      updateStepDisplay();
    }

    function goToStep(index) {
      if (index < 0 || index >= currentSteps.length) return;
      currentStepIndex = index;
      updateStepDisplay();
    }

    function updateStepDisplay() {
      // Determine the context (menu or recipe) based on whether infoOverlay or recipeDetails is visible
      const isMenuTab = document.getElementById('infoOverlay').style.display === 'flex';
      const isRecipeTab = document.getElementById('recipeDetails').style.display === 'block' || document.getElementById('recipeDetailsModal').style.display === 'flex';

      let stepImage, stepCounter, stepper;
      if (isMenuTab) {
        stepImage = document.getElementById('stepImage');
        stepCounter = document.getElementById('stepCounter');
        stepper = document.getElementById('stepper');
      } else if (isRecipeTab) {
        const container = isMobile ? document.getElementById('recipeModalContent') : document.getElementById('recipeDetails');
        stepImage = container.querySelector('.step-image');
        stepCounter = container.querySelector('.step-counter');
        stepper = container.querySelector('.stepper');
      }

      if (stepImage && currentSteps.length > 0) {
        stepImage.src = imageFolder + currentSteps[currentStepIndex];
      }
      if (stepCounter) {
        stepCounter.textContent = `${currentStepIndex + 1}/${currentSteps.length}`;
      }
      if (stepper) {
        const dots = stepper.querySelectorAll('.step-dot');
        dots.forEach((dot, index) => {
          dot.classList.toggle('active', index === currentStepIndex);
        });
      }
    }

    function navigateToPriceDatabase() {
      document.getElementById('menuPage').classList.remove('active');
      document.getElementById('priceDatabasePage').classList.add('active');
      displayPriceDatabase();
      setupCategoryFilters();
      document.getElementById("searchBar").focus();
    }

    // function zenbu() {
    //   searchBar.value = "";
    //   document.getElementById("searchBar").focus();
    // }

    function zenbu() {
      document.getElementById("searchBar").value = "";
      currentCategoryFilter = '';
      const filterButtons = document.querySelectorAll('.category-filter');
      filterButtons.forEach(btn => btn.classList.remove('selected'));
      Object.values(menuItems).forEach(item => {
        item.quantity = 1;
      });
      filterItems();
      document.getElementById("searchBar").focus();
    }

    function qfocus() {
      document.getElementById("searchBar").focus();
    }

    function navigateToMenu() {
      document.getElementById('priceDatabasePage').classList.remove('active');
      document.getElementById('recipeDatabasePage').classList.remove('active');
      document.getElementById('menuPage').classList.add('active');
      // reset search results
      searchBar.value = "";
      recipeSearchBar.value = "";
      generateImages();
    }

    function navigateToRecipeDatabase() {
      document.getElementById('menuPage').classList.remove('active');
      document.getElementById('recipeDatabasePage').classList.add('active');
      displayRecipeDatabase();
      document.getElementById('recipeDetails').style.display = 'none';
      document.getElementById('recipeDetailsModal').style.display = 'none';
      currentRecipe = null;
      isMobile = window.innerWidth <= 768;
      document.getElementById("recipeSearchBar").focus();
    }

    function displayPriceDatabase() {
      const itemList = document.getElementById('itemList');
      if (!itemList) {
        console.error('itemList element not found');
        return;
      }

      itemList.innerHTML = '';

      const items = Object.values(menuItems).filter(item => {
        const key = Object.keys(menuItems).find(key => menuItems[key] === item);
        return !excludedItems.includes(key);
      });

      if (items.length === 0) {
        itemList.innerHTML = '<p>表示するアイテムがありません</p>';
        return;
      }

      const categorizedItems = {};
      items.forEach(item => {
        const category = item.category || 'その他';
        if (!categorizedItems[category]) categorizedItems[category] = [];
        categorizedItems[category].push(item);
      });

      for (const category in categorizedItems) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        const categoryHeader = document.createElement('h3');
        categoryHeader.textContent = category;
        categoryDiv.appendChild(categoryHeader);

        categorizedItems[category].forEach(item => {
          const itemId = Object.keys(menuItems).find(key => menuItems[key] === item);
          const { regularFormatted, lunchFormatted } = calculatePrices(itemId);
          const hasMultiples = multipleItems.hasOwnProperty(itemId);

          const div = document.createElement('div');
          div.className = 'item';
          div.setAttribute('data-item-id', itemId);
          div.innerHTML = `
        <span class="item-name">${item.name}</span>
        <div class="right-container">
          ${item.shorthand ? `<span class="shorthand">${item.shorthand}</span>` : ''}
          <div class="price-container">
            <span class="price">${regularFormatted}</span>
            ${lunchFormatted !== null ? `<span class="lunch-price">ランチ: ${lunchFormatted}</span>` : ''}
            ${hasMultiples ? `
              <div class="quantity-controls">
                <button class="decrease" onclick="decreaseQuantity('${itemId}')">-</button>
                <span class="quantity">${item.quantity || 1}</span>
                <button class="increase" onclick="increaseQuantity('${itemId}')">+</button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
          categoryDiv.appendChild(div);
        });

        itemList.appendChild(categoryDiv);
      }
    }

    function filterItems() {
      const searchBar = document.getElementById('searchBar');
      const showLunchOnly = document.getElementById('showLunchOnly');
      const itemList = document.getElementById('itemList');

      if (!searchBar || !showLunchOnly || !itemList) return;

      const searchText = searchBar.value.toLowerCase();
      const lunchOnly = showLunchOnly.checked;

      const items = Object.values(menuItems).filter(item => {
        const key = Object.keys(menuItems).find(key => menuItems[key] === item);
        if (excludedItems.includes(key)) return false;

        const searchTerms = [
          item.name.toLowerCase(),
          ...(item.nicknames || []).map(n => n.toLowerCase())
        ];
        const matchesSearch = searchText ? searchTerms.some(term => term.includes(searchText)) : true;
        const matchesCategory = currentCategoryFilter ? item.category === currentCategoryFilter : true;
        const matchesLunch = lunchOnly ? item.lunchPrice !== undefined : true;

        return matchesSearch && matchesCategory && matchesLunch;
      });

      itemList.innerHTML = '';

      if (items.length === 0) {
        itemList.innerHTML = '<p>検索に一致するアイテムがありません</p>';
        return;
      }

      const categorizedItems = {};
      items.forEach(item => {
        const category = item.category || 'その他';
        if (!categorizedItems[category]) categorizedItems[category] = [];
        categorizedItems[category].push(item);
      });

      for (const category in categorizedItems) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        const categoryHeader = document.createElement('h3');
        categoryHeader.textContent = category;
        categoryDiv.appendChild(categoryHeader);

        categorizedItems[category].forEach(item => {
          const itemId = Object.keys(menuItems).find(key => menuItems[key] === item);
          const { regularFormatted, lunchFormatted } = calculatePrices(itemId);
          const hasMultiples = multipleItems.hasOwnProperty(itemId);

          const div = document.createElement('div');
          div.className = 'item';
          div.setAttribute('data-item-id', itemId);
          div.innerHTML = `
        <span class="item-name">${item.name}</span>
        <div class="right-container">
          ${item.shorthand ? `<span class="shorthand">${item.shorthand}</span>` : ''}
          <div class="price-container">
            <span class="price">${regularFormatted}</span>
            ${lunchFormatted !== null ? `<span class="lunch-price">ランチ: ${lunchFormatted}</span>` : ''}
            ${hasMultiples ? `
              <div class="quantity-controls">
                <button class="decrease" onclick="decreaseQuantity('${itemId}')">-</button>
                <span class="quantity">${item.quantity || 1}</span>
                <button class="increase" onclick="increaseQuantity('${itemId}')">+</button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
          categoryDiv.appendChild(div);
        });

        itemList.appendChild(categoryDiv);
      }
    }

    function setupCategoryFilters() {
      const filterButtons = document.querySelectorAll('.category-filter');
      if (filterButtons.length === 0) return;

      filterButtons.forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        newButton.addEventListener('click', () => {
          const category = newButton.getAttribute('data-category');
          const updatedFilterButtons = document.querySelectorAll('.category-filter');

          updatedFilterButtons.forEach(btn => btn.classList.remove('selected'));

          if (currentCategoryFilter === category && category !== '') {
            currentCategoryFilter = '';
          } else {
            currentCategoryFilter = category;
            if (category !== '') newButton.classList.add('selected');
          }

          filterItems();
        });
      });
    }

    // Add this variable near your other globals (e.g., after currentCategoryFilter)
    let currentRecipeCategoryFilter = '';

    // Modify displayRecipeDatabase to respect category filter
    function displayRecipeDatabase() {
      const recipeList = document.getElementById('recipeList');
      if (!recipeList) return;
      recipeList.innerHTML = '';

      const items = Object.values(recipeItems).filter(item => {
        return currentRecipeCategoryFilter ? item.category === currentRecipeCategoryFilter : true;
      });

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'recipe-card';
        div.setAttribute('role', 'listitem');
        div.setAttribute('tabindex', '0');
        const thumbnailSrc = item.steps && item.steps.length > 0 ? `${imageFolder}${item.steps[0]}` : null;
        div.innerHTML = `
      ${thumbnailSrc ? `<img src="${thumbnailSrc}" class="thumbnail" alt="${item.name}のサムネイル">` : '<div class="placeholder">画像なし</div>'}
      <div class="content">
        <div class="name">${item.name}</div>
        <div class="tags">${(item.tags || []).join(' • ')}</div>
      </div>
    `;
        div.onclick = () => selectRecipe(item);
        div.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectRecipe(item);
          }
        };
        recipeList.appendChild(div);
      });

      setupRecipeCategoryFilters(); // Call this to initialize filter buttons
    }

    // Update filterRecipes to include category filtering
    function filterRecipes() {
      const searchBar = document.getElementById('recipeSearchBar');
      const recipeList = document.getElementById('recipeList');
      if (!searchBar || !recipeList) return;

      const searchText = searchBar.value.toLowerCase();
      const items = Object.values(recipeItems);

      recipeList.innerHTML = '';

      const filteredItems = items.filter(item => {
        const searchTerms = [
          item.name.toLowerCase(),
          ...(item.nicknames || []).map(n => n.toLowerCase())
        ];
        const matchesSearch = searchText ? searchTerms.some(term => term.includes(searchText)) : true;
        const matchesCategory = currentRecipeCategoryFilter ? item.category === currentRecipeCategoryFilter : true;
        return matchesSearch && matchesCategory;
      });

      filteredItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'recipe-card';
        div.setAttribute('role', 'listitem');
        div.setAttribute('tabindex', '0');
        const thumbnailSrc = item.steps && item.steps.length > 0 ? `${imageFolder}${item.steps[0]}` : null;
        div.innerHTML = `
      ${thumbnailSrc ? `<img src="${thumbnailSrc}" class="thumbnail" alt="${item.name}のサムネイル">` : '<div class="placeholder">画像なし</div>'}
      <div class="content">
        <div class="name">${item.name}</div>
        <div class="tags">${(item.tags || []).join(' • ')}</div>
      </div>
    `;
        div.onclick = () => selectRecipe(item);
        div.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectRecipe(item);
          }
        };
        recipeList.appendChild(div);
      });
    }

    // Add new function to setup category filter buttons
    function setupRecipeCategoryFilters() {
      const filterButtons = document.querySelectorAll('.recipe-category-filter');
      if (filterButtons.length === 0) return;

      filterButtons.forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        newButton.addEventListener('click', () => {
          const category = newButton.getAttribute('data-category');
          const updatedFilterButtons = document.querySelectorAll('.recipe-category-filter');

          updatedFilterButtons.forEach(btn => btn.classList.remove('selected'));

          if (currentRecipeCategoryFilter === category && category !== '') {
            currentRecipeCategoryFilter = '';
          } else {
            currentRecipeCategoryFilter = category;
            if (category !== '') newButton.classList.add('selected');
          }

          filterRecipes();
        });
      });
    }

    // Add reset function
    function resetRecipeFilter() {
      currentRecipeCategoryFilter = '';
      document.getElementById('recipeSearchBar').value = '';
      const filterButtons = document.querySelectorAll('.recipe-category-filter');
      filterButtons.forEach(btn => btn.classList.remove('selected'));
      filterRecipes();
      document.getElementById('recipeSearchBar').focus();
    }

    // Add focus function for consistency
    function focusRecipeSearch() {
      document.getElementById('recipeSearchBar').focus();
    }

    function selectRecipe(item) {
      currentRecipe = item;
      const cards = document.querySelectorAll('.recipe-card');
      cards.forEach(card => card.classList.remove('selected'));
      const selectedCard = Array.from(cards).find(card => card.querySelector('.name').textContent === item.name);
      if (selectedCard) selectedCard.classList.add('selected');
      showRecipeInfo();
    }

    function showRecipeInfo() {
      if (!currentRecipe) return;

      currentSteps = currentRecipe.steps || [];
      currentStepIndex = 0;

      // Preload recipe step images
      if (currentSteps.length > 0) {
        preloadImages(currentSteps);
      }

      let additionalInfoHtml = '';
      if (currentRecipe.additionalInfo && currentRecipe.additionalInfo.length > 0) {
        additionalInfoHtml = currentRecipe.additionalInfo.map(info => `
      <details class="additional-info-item">
        <summary>${info.title}</summary>
        <p>${info.content}</p>
      </details>
    `).join('');
      }

      const content = `
    <h2>${currentRecipe.name}</h2>
    ${renderIngredients()}
    ${renderSteps()}
    ${renderVideo()}
    ${additionalInfoHtml ? `
      <div class="additional-info">
        ${additionalInfoHtml}
      </div>
    ` : ''}
  `;

      if (isMobile) {
        const modalContent = document.getElementById('recipeModalContent');
        modalContent.innerHTML = content;
        document.getElementById('recipeDetailsModal').style.display = 'flex';
        document.getElementById('recipeDetails').style.display = 'none';
      } else {
        const recipeDetails = document.getElementById('recipeDetails');
        recipeDetails.innerHTML = content;
        recipeDetails.style.display = 'block';
        document.getElementById('recipeDetailsModal').style.display = 'none';
      }

      updateStepDisplay();
    }

    function renderIngredients() {
      if (!Object.keys(currentRecipe.ingredients || {}).length) return '';
      let html = '<h3>材料</h3><table class="ingredient-table"><thead><tr><th>材料</th><th>量</th></tr></thead><tbody>';
      for (const [ingredient, amount] of Object.entries(currentRecipe.ingredients)) {
        html += `<tr><td>${ingredient}</td><td>${amount}</td></tr>`;
      }
      html += '</tbody></table>';
      return html;
    }

    function renderSteps() {
      let html = '<div class="step-by-step"><h3>作り方</h3>';
      if (currentSteps.length > 0) {
        html += `
          <div class="stepper">
            ${currentSteps.map((_, index) => `<span class="step-dot${index === 0 ? ' active' : ''}" onclick="goToStep(${index})" aria-label="ステップ${index + 1}"></span>`).join('')}
          </div>
          <div class="step-image-container">
            <img class="step-image" src="${imageFolder + currentSteps[0]}" alt="ステップ画像">
            <button class="step-nav step-prev" onclick="prevStep()" aria-label="前のステップ">◄</button>
            <button class="step-nav step-next" onclick="nextStep()" aria-label="次のステップ">►</button>
          </div>
          <div class="step-counter">${currentStepIndex + 1}/${currentSteps.length}</div>
        `;
      }
      html += `<div class="step-text">${parseStepText(currentRecipe.stepText || '"""ステップ情報がありません"""')}</div></div>`;
      return html;
    }

    function renderVideo() {
      if (!currentRecipe.videoLink) return '';
      return `
        <div class="video-section">
          <a href="${currentRecipe.videoLink}" target="_blank" rel="noopener noreferrer">レシピ動画</a>
        </div>
      `;
    }

    function closeRecipeDetails() {
      document.getElementById('recipeDetails').style.display = 'none';
      document.getElementById('recipeDetailsModal').style.display = 'none';
      currentRecipe = null;
      currentStepIndex = 0;
      currentSteps = [];
      const cards = document.querySelectorAll('.recipe-card');
      cards.forEach(card => card.classList.remove('selected'));
    }

    window.addEventListener('resize', () => {
      const wasMobile = isMobile;
      isMobile = window.innerWidth <= 768;
      if (wasMobile !== isMobile && currentRecipe) {
        closeRecipeDetails();
        showRecipeInfo();
      }
    });

    window.onload = () => {
      generateImages();
      setupCategoryFilters();
    };

    document.addEventListener('DOMContentLoaded', () => {
      const searchBar = document.getElementById('searchBar');
      const itemList = document.getElementById('itemList');

      // Store initial viewport height
      let initialHeight = window.innerHeight;

      // When search bar is focused (keyboard appears)
      searchBar.addEventListener('focus', () => {
        setTimeout(() => {
          // Check new height when keyboard is up
          const newHeight = window.innerHeight;
          if (newHeight < initialHeight) {
            // Keyboard is visible, adjust itemList height
            const keyboardHeight = initialHeight - newHeight;
            itemList.style.maxHeight = `calc(100vh - ${keyboardHeight + 100}px)`; // 100px for header + search
            // Scroll search bar into view
            searchBar.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100); // Delay to ensure keyboard is fully up
      });

      // Reset when keyboard hides
      searchBar.addEventListener('blur', () => {
        itemList.style.maxHeight = 'calc(100vh - 100px)'; // Reset to default
      });

      // Handle window resize (e.g., orientation change)
      window.addEventListener('resize', () => {
        initialHeight = window.innerHeight; // Update initial height
        if (!document.activeElement === searchBar) {
          itemList.style.maxHeight = 'calc(100vh - 100px)'; // Reset if keyboard not active
        }
      });
    });




    function increaseQuantity(itemId) {
      const item = menuItems[itemId];
      if (!item) return;
      item.quantity = Number(item.quantity || 1) + 1;
      updatePriceDisplay(itemId);
    }

    function decreaseQuantity(itemId) {
      const item = menuItems[itemId];
      if (!item) return;
      item.quantity = Math.max(1, Number(item.quantity || 1) - 1);
      updatePriceDisplay(itemId);
    }

    function calculatePrices(itemId) {
      const item = menuItems[itemId];
      const multiples = multipleItems[itemId];
      const quantity = Number(item.quantity) || 1;

      const processPriceArray = (priceInput, multipleInput) => {
        // Handle single number case
        if (!Array.isArray(priceInput)) {
          let price = Number(priceInput || 0);
          if (multiples && quantity > 1 && multipleInput) {
            const multiple = Number(multipleInput || 0); // Use single multiple if provided
            price += multiple * (quantity - 1);
          }
          return `${price}円`;
        }

        // Handle array case
        const formattedParts = [];
        let priceIndex = 0;

        priceInput.forEach((part) => {
          if (typeof part === 'number') {
            let price = Number(part);
            if (multiples && quantity > 1 && multipleInput) {
              const multiple = Number(Array.isArray(multipleInput) ? (multipleInput[priceIndex] || multipleInput[0] || 0) : (multipleInput || 0));
              price += multiple * (quantity - 1);
            }
            formattedParts.push(`${price}円`);
            priceIndex++;
          } else {
            formattedParts.push(part);
          }
        });

        return formattedParts.join('');
      };

      const regularFormatted = processPriceArray(item.price, multiples?.priceMultiple);
      const lunchFormatted = item.lunchPrice !== undefined ? processPriceArray(item.lunchPrice, multiples?.lunchPriceMultiple) : null;

      return { regularFormatted, lunchFormatted };
    }

    function updatePriceDisplay(itemId) {
      const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
      if (!itemElement) return;

      const { regularFormatted, lunchFormatted } = calculatePrices(itemId);
      const item = menuItems[itemId];

      itemElement.querySelector('.price').textContent = regularFormatted;
      if (lunchFormatted !== null) {
        const lunchElement = itemElement.querySelector('.lunch-price');
        if (lunchElement) lunchElement.textContent = `ランチ: ${lunchFormatted}`;
      }
      itemElement.querySelector('.quantity').textContent = item.quantity || 1;
    }

    // Add this function (unchanged from previous response, but with a console log)
    function preloadImages(imageArray) {
      const preloadContainer = document.createElement('div');
      preloadContainer.style.display = 'none';
      document.body.appendChild(preloadContainer);

      console.log('Preloading images:', imageArray); // Log to verify all images are preloaded

      imageArray.forEach(image => {
        const img = new Image();
        img.src = imageFolder + image;
        preloadContainer.appendChild(img);
      });
    }
  </script>
</body>

</html>